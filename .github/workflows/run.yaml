name: Generate Opera Proxy Config

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */12 * * *'  # 每12小时运行一次

jobs:
  generate-config:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up environment
        run: |
          echo "TIMESTAMP=$(date -u +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Download opera-proxy
        run: |
          wget https://github.com/Snawoot/opera-proxy/releases/download/v1.11.2/opera-proxy.linux-amd64
          chmod +x opera-proxy.linux-amd64

      - name: Generate proxy configurations
        run: |
          # 为每个地区生成配置
          for region in "EU" "AS" "AM"; do
            # 生成代理信息并保存到临时文件
            ./opera-proxy.linux-amd64 -country $region -list-proxies > "${region}_proxy_output.txt"
            
            # 解析输出并创建 clash 配置
            PROXY_LOGIN=$(grep "Proxy login:" "${region}_proxy_output.txt" | cut -d ' ' -f 3)
            PROXY_PASSWORD=$(grep "Proxy password:" "${region}_proxy_output.txt" | cut -d ' ' -f 3)
            
            # 创建对应地区的 clash 配置文件
            echo "proxies:" > "${region}_clash-config.yml"
            
            # 根据地区设置国家名称
            case $region in
              "AM") COUNTRY="美国" ;;
              "AS") COUNTRY="新加坡" ;;
              "EU") COUNTRY="挪威" ;;
            esac
            
            # 处理每个代理服务器
            grep -E "^[^,]+,[^,]+,[^,]+$" "${region}_proxy_output.txt" | while IFS=, read -r host ip port; do
              # 获取域名的前三个字母
              PREFIX=$(echo $host | cut -c1-3)
              
              cat >> "${region}_clash-config.yml" << EOF
- name: ${COUNTRY}-${PREFIX}
  type: http
  server: ${ip}
  port: ${port}
  username: ${PROXY_LOGIN}
  password: ${PROXY_PASSWORD}
  tls: true
  skip-cert-verify: false
  sni: ${host}
EOF
            done
          done
          
          # 合并所有配置文件
          echo "proxies:" > clash-config.yml
          for region in "EU" "AS" "AM"; do
            tail -n +2 "${region}_clash-config.yml" >> clash-config.yml
          done

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add clash-config.yml
          git commit -m "Update proxy configuration ${TIMESTAMP}"
          git push
